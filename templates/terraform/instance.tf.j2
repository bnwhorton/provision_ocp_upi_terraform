
module "{{ instance }}" {
  source		= "./modules/vms"
  cluster_id		= var.cluster_id
  vm_name		= var.vm_name
  vm_hostname		= var.vm_hostname
  vm_dns_search		= var.vm_dns_search
  vm_dns_servers	= var.vm_dns_servers    
  vm_memory		= var.vm_memory
  vm_cpu_cores		= var.vm_cpu_cores
  vm_template_id	= var.vm_template_id
} 

{% if hostvars[instance]['additional_disks'] | d([]) | length > 0 and hostvars[instance]['attach_additional_disks'] | d(false) | bool %}
{% set dindex = 0 %}
{% for disk in hostvars[instance]['additional_disks'] %}

module "{{ instance }}-{{ disk.name }}" {
  source		= "./modules/disk"
  storage_domain_id	= var.storage_domain_id
  disk_name		= var.{{ instance }}-disk_name{{ dindex }}
  disk_size		= var.{{ instance}}-disk_size{{ dindex }}
  disk_format           = var.disk_format
  vm_id			= module.{{ instance }}.id 
  bootable		= var.bootable
} 
{% set dindex = dindex + 1 %}
{% endfor %}
{% endif %}
